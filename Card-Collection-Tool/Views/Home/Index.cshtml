@{
    ViewData["Title"] = "Home Page";
}

<div class="text-center">
    <h1 class="display-4">Card Collection App</h1>
    <a asp-controller="Home" asp-action="Collections" class="btn btn-outline-primary">Collections</a>
</div>


@model List<Card_Collection_Tool.Services.ScryfallCard>

<h2>Search Cards</h2>

<!-- Search field and button directly in Index.cshtml -->
<div class="input-group mb-3">
    <input type="text" id="searchQuery" placeholder="Enter card name or keywords..." class="form-control" />
    <button id="searchButton" class="btn btn-primary">Search</button>
</div>

<div id="searchResults">
    <!-- Display search results -->
    @if (Model != null && Model.Count > 0)
    {
        <h3>Results</h3>
        <div class="row">
            @foreach (var card in Model)
            {
                <div class="col-md-4 card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">@card.Name</h5>

                        <!-- Display card image -->
                        @if (card.ImageUris != null && !string.IsNullOrEmpty(card.ImageUris.Normal))
                        {
                            <img src="@card.ImageUris.Normal" alt="@card.Name" class="img-fluid" />
                        }

                        <p class="card-text"><small>@card.OracleText</small></p>
                        <p class="card-text">Set: @card.SetName</p>
                    </div>
                </div>
            }
        </div>
    }
    else if (Model != null)
    {
        <p>No cards found. Please try a different search.</p>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Document is ready, setting up button click event.");

            // Set up the button click event
            document.getElementById("searchButton").addEventListener("click", function () {
                console.log("Search button clicked.");
                var query = document.getElementById("searchQuery").value;

                if (query.trim() === "") {
                    console.error("Search query is empty.");
                    alert("Please enter a search query.");
                    return;
                }

                // Send a fetch request to the server-side endpoint
                fetch('@Url.Action("SearchCards", "Cards")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({ query: query })
                })
                    .then(response => response.json()) // Parse the JSON response
                    .then(data => {
                        if (!data.success) {
                            console.error("Server error:", data.message);
                            alert(data.message);
                            return;
                        }

                        console.log("Fetch request successful. Rendering results.", data); // Log the full response data for debugging

                        var resultsContainer = document.getElementById("searchResults");
                        resultsContainer.innerHTML = ""; // Clear previous results

                        if (data.data && data.data.length > 0) {
                            var resultsHtml = "<h3>Results</h3><div class='row'>";

                            data.data.forEach(function (card) {
                                console.log("Card data: ", card); // Log each card object for debugging

                                // Check for null or undefined properties to avoid errors
                                var name = card.name || "Unknown Name";
                                var oracleText = card.oracle_text || "No description available.";
                                var setName = card.set_name || "Unknown Set";
                                var imageUrl = (card.image_uris.png && card.image_uris.normal) ? card.image_uris.normal : ''; // Check for image URL

                                // Render the card information
                                resultsHtml += `
                                        <div class="col-md-4 card mb-4">
                                            <div class="card-body">
                                                <h5 class="card-title">${name}</h5>
                                                <img src="${imageUrl}" alt="${name}" class="img-fluid" />
                                                <p class="card-text"><small>${oracleText}</small></p>
                                                <p class="card-text">Set: ${setName}</p>
                                            </div>
                                        </div>
                                    `;
                            });

                            resultsHtml += "</div>";
                            resultsContainer.innerHTML = resultsHtml;
                        } else {
                            resultsContainer.innerHTML = "<p>No cards found. Please try a different search.</p>";
                        }
                    })
                    .catch(error => {
                        console.error("Error occurred during Fetch request:", error);
                        alert("An unexpected error occurred. Please try again later.");
                    });
            });
        });
    </script>
}

